name: Playwright Automation (Test 50)

# 1. Manual Trigger Only (No automatic schedule)
on:
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 60 # Set to 60 mins since 10 accounts take ~15-20 mins

    # === CONFIGURATION FOR 50 ACCOUNTS (10 PER COMPUTER) ===
    # Math: 50 Accounts / 10 per Comp = 5 Computers needed.
    strategy:
      fail-fast: false
      matrix:
        # We launch 5 computers (Indexes 0, 1, 2, 3, 4)
        shard: [0, 1, 2, 3, 4]
    # =======================================================

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Cache Playwright Browsers
        id: playwright-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/requirements.txt') }}

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Create Accounts File
        # Make sure your secret 'ACCOUNTS_CSV' has all 50 accounts!
        run: echo "${{ secrets.ACCOUNTS_CSV }}" > accounts.csv

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: playwright install chromium

      - name: Run script (Shard ${{ matrix.shard }})
        env:
          PYTHONUNBUFFERED: 1
          # Pass the shard index (0, 1, 2, 3, or 4)
          SHARD_INDEX: ${{ matrix.shard }}
          # Set this to 5 so the script knows to split the list by 5
          TOTAL_SHARDS: 5
        run: python -u account_automation.py

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: results-shard-${{ matrix.shard }}
          path: |
            account_balances.csv
            failed_accounts.csv
            progress.json
            screenshots/
