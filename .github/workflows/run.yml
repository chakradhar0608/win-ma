name: Playwright Automation (300 Accounts)

# 1. Manual Trigger Only
on:
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    # Reduced timeout because 10 accounts should finish quickly
    timeout-minutes: 60 

    # === CONFIGURATION FOR 300 ACCOUNTS (10 PER SHARD) ===
    # Math: 300 Accounts / 30 Shards = 10 Accounts per run.
    strategy:
      fail-fast: false
      max-parallel: 20 # GitHub Free limit is usually 20 concurrent jobs
      matrix:
        # We launch 30 shards (Indexes 0 to 29)
        shard: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29]
    # =====================================================

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Cache Playwright Browsers
        id: playwright-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/requirements.txt') }}

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install playwright

      - name: Create Accounts File
        # CRITICAL: Filename matches your Python config variable ACCOUNTS_FILE
        run: echo "${{ secrets.ACCOUNTS_CSV }}" > accounts.csv

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: playwright install chromium

      - name: Run script (Shard ${{ matrix.shard }})
        env:
          PYTHONUNBUFFERED: 1
          # Pass the shard index (0 to 29)
          SHARD_INDEX: ${{ matrix.shard }}
          # Set this to 30 so the script splits 300 accounts into chunks of 10
          TOTAL_SHARDS: 30
        run: python -u account_automation.py
        # Note: Ensure your python filename is main.py or update the line above

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: results-shard-${{ matrix.shard }}
          path: |
            account_balances.csv
            output_chakri.txt
            progress.json
            screenshots/
