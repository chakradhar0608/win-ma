name: Playwright Automation (300 Accounts)

on:
  workflow_dispatch:

jobs:
  # ==========================================
  # JOB 1: THE WORKER SHARDS
  # ==========================================
  run-bots:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    strategy:
      fail-fast: false
      max-parallel: 20
      matrix:
        # 30 shards (0-29) processing ~10 accounts each
        shard: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Cache Playwright Browsers
        id: playwright-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/requirements.txt') }}

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install playwright

      - name: Create Accounts File
        # Fixed: Writes to 'ch_accounts_reversed.csv' to match your Python config
        run: echo "${{ secrets.ACCOUNTS_CSV }}" > accounts.csv

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: playwright install chromium

      - name: Run script (Shard ${{ matrix.shard }})
        env:
          PYTHONUNBUFFERED: 1
          SHARD_INDEX: ${{ matrix.shard }}
          TOTAL_SHARDS: 30
        # Running your specific script name
        run: python -u account_automation.py

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: results-shard-${{ matrix.shard }}
          path: |
            account_balances.csv
            output_chakri.txt
            progress.json
            screenshots/

  # ==========================================
  # JOB 2: MERGE RESULTS (Runs after ALL shards)
  # ==========================================
  merge-results:
    needs: run-bots
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: results-shard-*
          path: all_results
          # We do NOT merge multiple here because we want to keep folder structure 
          # to separate the identical filenames (account_balances.csv)

      - name: Merge CSV Files
        run: |
          echo "Starting CSV Merge..."
          # Find the first CSV to get the header
          first_file=$(find all_results -name "account_balances.csv" | head -n 1)
          
          if [ -z "$first_file" ]; then
            echo "No CSV files found!"
            exit 0
          fi

          # Copy header from first file
          head -n 1 "$first_file" > final_account_balances.csv

          # Loop through all CSVs and append data (skipping headers)
          find all_results -name "account_balances.csv" -exec tail -n +2 -q {} + >> final_account_balances.csv
          
          echo "âœ… Merged CSV created with $(wc -l < final_account_balances.csv) lines."

      - name: Merge TXT Files
        run: |
          # Also merging your output_chakri.txt files just in case
          find all_results -name "output_chakri.txt" -exec cat {} + >> final_output_chakri.txt

      - name: Upload Final Merged Files
        uses: actions/upload-artifact@v4
        with:
          name: FINAL_COMBINED_RESULTS
          path: |
            final_account_balances.csv
            final_output_chakri.txt
